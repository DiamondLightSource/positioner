# RULES.Db
# Usage: 
# Place this file in your $TOP/configure directory.
# Include this file before $(TOP)/configure/RULES in your *App/Db Makefile.
#
# This file does two things:
# Provides a rule for translating what the msi document calls dbTemplate
# format substitution files into db files.
#
# Provides for the extraction of request files and archive request files
# from templates.
#
# To use this file you must define USES_TEMPLATE to include the template
# files that you include.  These can have any suffix. 
# 

# flatten any vdb files into a template file
$(COMMON_DIR)/%.template: %.vdb $(VDB_DEPS)
	@echo "Flattening $< to produce $@ " 
	@flatdb $< $@ 

# translate a a dbTemplate style substitution file.
$(COMMON_DIR)/%.db$(RAW): %.substitutions $(USES_TEMPLATE)
	@ln -f -s $^ .
	@echo "Inflating database from $< using local rule"
	$(RM) $@
	$(DBDEPENDS_CMD)
	$(MSI) -S$< </dev/null > msi.tmp
	$(MV) msi.tmp $@
	@rm -f $(notdir $^)



# request file and arReq file record attributes look like this
# in the template file:
# # @arReq $(S)_$(SS):GateGen$(N)_$(DI):ParityError 600 Monitor
#
# extract a auto save restore file from a completed db file
$(INSTALL_DB)/%.req: $(COMMON_DIR)/%.req
	cp $< $@
$(COMMON_DIR)/%.req: $(COMMON_DIR)/%.db$(RAW)
	@ echo "Extracting $@ from $<"
	@ grep "@req" $< | sed ' s/# *@req *// ' > $@

$(COMMON_DIR)/%.req: %.db
	@ echo "Extracting $@ from $<"
	@ grep "@req" $< | sed ' s/# *@req *// ' > $@

$(COMMON_DIR)/%.req: %.template
	@ echo "Extracting $@ from $<"
	@ grep "@req" $< | sed ' s/# *@req *// ' > $@

$(INSTALL_DB)/%.arReq: $(COMMON_DIR)/%.arReq
	cp $< $@
$(COMMON_DIR)/%.arReq: $(COMMON_DIR)/%.db$(RAW)
	@ echo "Extracting $@ from $<"
	@ grep "@arReq" $< | sed ' s/# *@arReq *// ' > $@
